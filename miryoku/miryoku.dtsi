// Copyright 2022 Manna Harbour
// https://github.com/manna-harbour/miryoku

#include <behaviors.dtsi>
#include <dt-bindings/zmk/mouse.h>
#include <dt-bindings/zmk/pointing.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/rgb.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/ext_power.h>
#include <input/processors.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>

#include "miryoku.h"

&mmv_input_listener { input-processors = <&zip_xy_scaler 2 1>; };

&msc_input_listener { input-processors = <&zip_scroll_scaler 2 1>; };

	&msc {
		acceleration-exponent = <1>;
		time-to-max-speed-ms = <100>;
		delay-ms = <0>;
	};

	&mmv {
		time-to-max-speed-ms = <500>;
		acceleration-exponent = <1>;
		trigger-period-ms = <16>;
	};


/ {
	rgb_encoder: rgb_encoder {
		compatible = "zmk,behavior-sensor-rotate"; \
		#sensor-binding-cells = <0>; \
		bindings = <&rgb_ug RGB_BRI>, <&rgb_ug RGB_BRD>; \
	};

	scroll_encoder: scroll_encoder {
		compatible = "zmk,behavior-sensor-rotate"; \
		#sensor-binding-cells = <0>; \
		bindings = <&msc SCRL_UP>, <&msc SCRL_DOWN>; \
	};

	undo_redo_encoder: undo_redo_encoder {
		compatible = "zmk,behavior-sensor-rotate"; \
		#sensor-binding-cells = <0>; \
		bindings = <&kp K_AGAIN>, <&kp K_UNDO>; \
	};

	volume_encoder: volume_encoder {
		compatible = "zmk,behavior-sensor-rotate"; \
		#sensor-binding-cells = <0>; \
		bindings = <&kp C_VOL_UP>, <&kp C_VOLUME_DOWN>; \
	};

	left_right_encoder: left_right_encoder {
		compatible = "zmk,behavior-sensor-rotate";
		#sensor-binding-cells = <0>;
		bindings = <&kp RIGHT>, <&kp LEFT>; \
	};

	up_down_encoder: up_down_encoder {
		compatible = "zmk,behavior-sensor-rotate";
		#sensor-binding-cells = <0>;
		bindings = <&kp UP>, <&kp DOWN>; \
	};

	keymap {
		compatible = "zmk,keymap";
		#define MIRYOKU_X(LAYER, STRING, EXTRA) \
		LAYER { \
			display-name = STRING; \
			bindings = < U_MACRO_VA_ARGS(MIRYOKU_LAYERMAPPING_##LAYER, MIRYOKU_LAYER_##LAYER) >; \
			EXTRA \
		};
		MIRYOKU_LAYER_LIST
		#undef MIRYOKU_X
	};
};

#include "miryoku_shift_functions.dtsi"

#include "miryoku_double_tap_guard.dtsi"

#if defined (MIRYOKU_KLUDGE_MOUSEKEYSPR)
#include "miryoku_kludge_mousekeyspr.dtsi"
#else
#include "miryoku_mousekeys.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_THUMBCOMBOS)
#include "miryoku_kludge_thumbcombos.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_TOPROWCOMBOS)
#include "miryoku_kludge_toprowcombos.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_BOTTOMROWCOMBOS)
#include "miryoku_kludge_bottomrowcombos.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_TAPDELAY)
#include "miryoku_kludge_tapdelay.dtsi"
#else
#include "miryoku_behaviors.dtsi"
#endif
